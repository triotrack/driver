<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triotrack Driver Portal</title>
    <style>
        body { font-family: system-ui, sans-serif; background: #0f172a; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: #1e293b; padding: 2rem; border-radius: 1.5rem; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid #334155; }
        h1 { color: #2dd4bf; margin-bottom: 0.5rem; }
        select { width: 100%; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.75rem; background: #334155; color: white; border: none; font-size: 1rem; }
        button { width: 100%; padding: 1rem; border-radius: 0.75rem; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        .btn-start { background: #0d9488; color: white; }
        .btn-stop { background: #ef4444; color: white; display: none; }
        .status { margin-top: 1.5rem; font-size: 0.9rem; color: #94a3b8; }
        .pulse { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #ef4444; margin-right: 5px; }
        .pulse.active { background: #22c55e; box-shadow: 0 0 10px #22c55e; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="card">
        <h1>Driver Portal</h1>
        <p style="color:#64748b; margin-bottom: 2rem;">Select Bus & Start Trip</p>
        
        <select id="bus-select">
            <option value="KL-55-A">KL-55-A (Super Fast)</option>
            <option value="KL-12-B">KL-12-B (Limited Stop)</option>
        </select>

        <button id="start-btn" class="btn-start" onclick="startTracking()">Start Tracking</button>
        <button id="stop-btn" class="btn-stop" onclick="stopTracking()">Stop Tracking</button>

        <div class="status">
            <span id="status-dot" class="pulse"></span>
            <span id="status-text">Status: Offline</span>
        </div>
        <div id="debug" style="margin-top:15px; font-family:monospace; font-size:0.75rem; color:#ef4444; background:#1e293b; padding:5px; border-radius:5px;"></div>
    </div>

    <script type="module">
        // 1. Using setDoc instead of updateDoc to AUTO-CREATE documents
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDcWwo0m2eS1ndyC06U1G_JF1J7Y1WNlfQ",
            authDomain: "triotrack-66dd6.firebaseapp.com",
            projectId: "triotrack-66dd6",
            storageBucket: "triotrack-66dd6.firebasestorage.app",
            messagingSenderId: "994389952848",
            appId: "1:994389952848:web:659fbc330f2d660dfb0455",
            measurementId: "G-B7TMFX0F21"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let watchId = null;

        window.startTracking = () => {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser");
                return;
            }

            const busId = document.getElementById('bus-select').value;
            
            // UI Updates
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'block';
            document.getElementById('bus-select').disabled = true;
            document.getElementById('status-dot').classList.add('active');
            document.getElementById('status-text').innerText = "Acquiring GPS...";
            document.getElementById('status-text').style.color = "#fbbf24"; // Yellow
            document.getElementById('debug').innerText = "";

            watchId = navigator.geolocation.watchPosition(async (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const speed = position.coords.speed || 0;

                try {
                    // Use setDoc with merge:true. 
                    // This creates the document 'KL-55-A' if it doesn't exist yet.
                    const busRef = doc(db, "live_locations", busId);
                    await setDoc(busRef, {
                        lat: lat,
                        lng: lng,
                        speed: speed,
                        last_updated: serverTimestamp()
                    }, { merge: true });

                    // Success Feedback
                    document.getElementById('status-text').innerText = "Status: Broadcasting Live";
                    document.getElementById('status-text').style.color = "#22c55e"; // Green
                    document.getElementById('debug').style.color = "#22c55e";
                    document.getElementById('debug').innerText = `Sent: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;

                } catch (error) {
                    // Error Feedback
                    console.error("Firebase Error:", error);
                    document.getElementById('status-text').innerText = "Upload Failed";
                    document.getElementById('status-text').style.color = "#ef4444";
                    document.getElementById('debug').style.color = "#ef4444";
                    document.getElementById('debug').innerText = "DB Error: " + error.message;
                }
            }, (error) => {
                // GPS Error Feedback
                console.error("GPS Error:", error);
                document.getElementById('status-text').innerText = "GPS Error";
                document.getElementById('debug').innerText = "GPS: " + error.message;
            }, {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 10000
            });
        };

        window.stopTracking = () => {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('stop-btn').style.display = 'none';
            document.getElementById('bus-select').disabled = false;
            document.getElementById('status-dot').classList.remove('active');
            document.getElementById('status-text').innerText = "Status: Offline";
            document.getElementById('status-text').style.color = "#94a3b8";
            document.getElementById('debug').innerText = "";
        };
    </script>
</body>
</html>
